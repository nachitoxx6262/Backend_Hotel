============================================================
ACTUALIZACIÓN DE TABLAS – FASE 3 (Backend/Frontend Integración)
Fecha: 2025-12-12
============================================================

Nota: Este archivo contiene sentencias SQL listas para ejecutar
sobre PostgreSQL. Incluye "IF NOT EXISTS" para ser idempotente.
Ejecutar en el orden indicado. Ajustar nombres de esquema si aplica.

------------------------------------------------------------
1) Tabla: reservas
Propósito: Campos operacionales y financieros requeridos por Fase 2/3
------------------------------------------------------------

ALTER TABLE reservas
    ADD COLUMN IF NOT EXISTS estado_operacional VARCHAR(32) DEFAULT 'PENDIENTE' NOT NULL;

ALTER TABLE reservas
    ADD COLUMN IF NOT EXISTS estado_habitacion VARCHAR(32) DEFAULT 'EN_USO' NOT NULL;

ALTER TABLE reservas
    ADD COLUMN IF NOT EXISTS usuario_actual VARCHAR(64);

ALTER TABLE reservas
    ADD COLUMN IF NOT EXISTS monto_pagado NUMERIC(12,2) DEFAULT 0 NOT NULL,
    ADD COLUMN IF NOT EXISTS saldo_pendiente NUMERIC(12,2) DEFAULT 0 NOT NULL;

ALTER TABLE reservas
    ADD COLUMN IF NOT EXISTS notas_internas TEXT;

ALTER TABLE reservas
    ADD COLUMN IF NOT EXISTS creado_en TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    ADD COLUMN IF NOT EXISTS actualizado_en TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    ADD COLUMN IF NOT EXISTS creado_por VARCHAR(64),
    ADD COLUMN IF NOT EXISTS actualizado_por VARCHAR(64);

CREATE INDEX IF NOT EXISTS ix_reservas_estado_operacional ON reservas (estado_operacional);
CREATE INDEX IF NOT EXISTS ix_reservas_estado_habitacion ON reservas (estado_habitacion);

-- Opcional: Backfill de estado_operacional basado en estado
-- Ajustar mapping según reglas del negocio
UPDATE reservas SET estado_operacional = CASE estado
    WHEN 'CONFIRMADA' THEN 'EN_CURSO'
    WHEN 'CHECKIN'    THEN 'EN_CURSO'
    WHEN 'CHECKOUT'   THEN 'CERRADA'
    WHEN 'CANCELADA'  THEN 'CANCELADA'
    ELSE COALESCE(estado_operacional, 'PENDIENTE')
END
WHERE estado_operacional IS NULL;

-- Opcional: Recalcular saldo_pendiente si ya existe total y pagos
UPDATE reservas
SET saldo_pendiente = GREATEST(COALESCE(total, 0) - COALESCE(monto_pagado, 0), 0);

------------------------------------------------------------
2) Tabla: reservas_eventos (si existe)
Propósito: Asegurar JSONB y columnas necesarias
------------------------------------------------------------

-- Si la tabla existe y el campo data debe ser JSONB
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'reservas_eventos' AND column_name = 'data'
    ) THEN
        ALTER TABLE reservas_eventos
            ALTER COLUMN data TYPE JSONB USING data::JSONB;
    END IF;
END $$;

-- Índice para timestamp/tipo_evento si no existen
CREATE INDEX IF NOT EXISTS ix_reservas_eventos_timestamp ON reservas_eventos (timestamp);
CREATE INDEX IF NOT EXISTS ix_reservas_eventos_tipo ON reservas_eventos (tipo_evento);

------------------------------------------------------------
3) Tabla: reservas_huespedes (si existe)
Propósito: Datos de huésped y rol
------------------------------------------------------------

ALTER TABLE reservas_huespedes
    ADD COLUMN IF NOT EXISTS rol VARCHAR(16) DEFAULT 'adulto' NOT NULL,
    ADD COLUMN IF NOT EXISTS nacionalidad VARCHAR(64),
    ADD COLUMN IF NOT EXISTS genero VARCHAR(8),
    ADD COLUMN IF NOT EXISTS direccion VARCHAR(128);

-- Índice básico por reserva
CREATE INDEX IF NOT EXISTS ix_res_huespedes_reserva_id ON reservas_huespedes (reserva_id);

------------------------------------------------------------
4) Tabla: reservas_pagos (si existe)
Propósito: Registro de pagos operacionales
------------------------------------------------------------

ALTER TABLE reservas_pagos
    ADD COLUMN IF NOT EXISTS metodo VARCHAR(32) DEFAULT 'EFECTIVO' NOT NULL,
    ADD COLUMN IF NOT EXISTS referencia VARCHAR(64),
    ADD COLUMN IF NOT EXISTS notas TEXT;

-- Índices útiles
CREATE INDEX IF NOT EXISTS ix_res_pagos_reserva_id ON reservas_pagos (reserva_id);
CREATE INDEX IF NOT EXISTS ix_res_pagos_timestamp ON reservas_pagos (timestamp);

------------------------------------------------------------
5) Consulta de reservas (para endpoints/listados)
Propósito: Evitar nulls y alinear con nuevos campos
------------------------------------------------------------

-- Ejemplo de SELECT actualizado
-- (usar en consultas o views/materialized views)
SELECT
  r.id                                AS reservas_id,
  r.cliente_id                        AS reservas_cliente_id,
  r.empresa_id                        AS reservas_empresa_id,
  r.nombre_temporal                   AS reservas_nombre_temporal,
  r.fecha_checkin                     AS reservas_fecha_checkin,
  r.fecha_checkout                    AS reservas_fecha_checkout,
  r.fecha_checkin_real                AS reservas_fecha_checkin_real,
  r.fecha_checkout_real               AS reservas_fecha_checkout_real,
  r.cantidad_adultos                  AS reservas_cantidad_adultos,
  r.cantidad_menores                  AS reservas_cantidad_menores,
  r.estado                            AS reservas_estado,
  COALESCE(r.estado_operacional, 'PENDIENTE')      AS reservas_estado_operacional,
  r.subtotal                          AS reservas_subtotal,
  r.descuento                         AS reservas_descuento,
  r.impuestos                         AS reservas_impuestos,
  r.total                             AS reservas_total,
  COALESCE(r.monto_pagado, 0)         AS reservas_monto_pagado,
  COALESCE(r.saldo_pendiente, 0)      AS reservas_saldo_pendiente,
  COALESCE(r.estado_habitacion, 'EN_USO')          AS reservas_estado_habitacion,
  r.usuario_actual                    AS reservas_usuario_actual,
  r.notas_internas                    AS reservas_notas_internas,
  r.deleted                           AS reservas_deleted,
  r.notas                             AS reservas_notas,
  r.creado_en                         AS reservas_creado_en,
  r.creado_por                        AS reservas_creado_por,
  r.actualizado_en                    AS reservas_actualizado_en,
  r.actualizado_por                   AS reservas_actualizado_por
FROM reservas r
WHERE r.deleted IS FALSE;

------------------------------------------------------------
Instrucciones
------------------------------------------------------------
1. Ejecutar bloque (1) para tabla reservas.
2. Si su BD contiene las tablas (2)-(4), ejecutar los bloques respectivos.
3. (Opcional) Ejecutar backfills.
4. Reiniciar el backend y validar GET /reservas.

Fin del documento.
